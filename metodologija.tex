\lstset{language=Python}
\lstset{frame=tb,
  language=Python,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\small\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{myteal},
  commentstyle=\color{myblue},
  stringstyle=\color{myyellow},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3
}

\chapter{Metodologija}
\label{chMe}
Okviren potek zagozdenja sistema:
\begin{enumerate}
\item Z Mitchellovim algoritmom~\cite{mitch} ustvarimo dvodimenzionalno mrežo z $N$ 
    točkami.
\item Točke postanejo središča elips z~ekscentričnostjo $e$ in naključnimi začetnimi 
    orientacijami.
\item Implementacija prekrivalne funkcije~\cite{perram1985} za zaznavanje trkov med 
    elipsami.
\item Postopno večanje elips in relaksacija vrtenja (Monte Carlo).
\item Analiza konfiguracij.
\end{enumerate}
Periodične robne pogoje v~kodi implementiramo na naslednji način
\begin{lstlisting}[frame=single]  
    dx = point2 - point1
    if dx > 0.5*width:
        dx = dx - width
    elif dx < -0.5*width:
        dx = dx + width
\end{lstlisting}

\section{Mitchellov algoritem}
Okviren potek algoritma:
\begin{enumerate}
    \item Postavimo začetni točki na naključna položaja.
    \item Zgeneriramo naključne položaje kandidatov za naslednjo točko.
    \item Izberemo kandidata, ki je najdlje od vseh točk porazdelitve 
    (ima največjo minimalno oddaljenost).
    \item Ponavljamo prejšnje korake dokler ne dosežemo izbranega števila točk.
\end{enumerate}
Na vsaki ponovitvi število kandidatov povečamo sorazmerno s~številom že 
obstoječih točk $n$. Pri nalogi smo tako vsakič generirali 
$ \left \lfloor{n/2}\right \rfloor + 1$ kandidatov.\\
%% napisi se nek del kako je to kul in primerjavo z modrim sumom blabla
Primer za porazdelitev $1024$ točk je prikazana na sliki~\ref{fig:porazdelitev_tock}.
Zdaj v~točke postavimo elipse enakih velikosti ($a$, $b$ in $e$) in naključnih
orientacij $\theta_i$. Potrebujemo še kriterij za zaznavanje prekritih elips,
kar je predstavljeno v~naslednjem razdelku.
\begin{figure}[!ht]
    \centering
    \resizebox{.7\textwidth}{!}{\input{./gnuplot/porazdelitev_1024.tex}}
    \caption[Blue noise]{Porazdelitev $1024$ točk.}
    \label{fig:porazdelitev_tock}
\end{figure}

\section{Eliptična kontaktna funkcija}
Za zaznavanje prekrivanja para elips implementiramo kontaktno funkcijo, povzeto
po~\cite{perram1985}.

\subsection{Ena elipsa}
Elipsa $A$ je definirana s~centrom $\vec{r}_A$, orientacijo $\theta_A$ in pozitivno 
definitno kvadratično formo $\mathbf{A}$ kot množica točk, za katero velja
\begin{equation}
    E_A (\vec{r}-\vec{r}_A, \theta_A) = 
    (\vec{r} - \vec{r}_A)^{\top} \mathbf{A}^{-1} (\vec{r} - \vec{r}_A)
    \begin{cases}
        \quad <1 & \text{znotraj A},\\
        \quad =1 & \text{na površini A},\\
        \quad >1 & \text{zunaj A}.
    \end{cases}
    \label{eq:elipsa}
\end{equation}
Z~uporabo rotacijske matrike $R(\theta)$ lahko $\mathbf{A}$ zapišemo kot
\begin{equation}
    \mathbf{A} (\theta_A) = \mathbf{R}(\theta_A) \hat{\mathbf{A}} 
                            \mathbf{R}^{\top}(\theta_A).
\end{equation}
Kjer je $\hat{\mathbf{A}}$ določena z~velikostjo polosi elipse $a_1$ in $a_2$ 
ter enotskih vektorjev $\vec{e}_i$ 
\begin{equation}
    \hat{\mathbf{A}} = \sum_{i=1}^{2} a_i^2 \vec{e}_i \vec{e}_i^{\top}.
\end{equation}

\subsection{Prekrivanje dveh elips}
Definiramo funkcijo
\begin{equation}
    F(\vec{r}, \lambda) = \lambda E_A (\vec{r}) + (1 - \lambda) E_B (\vec{r}),
    \label{eq:F}
\end{equation}
kot vsoto dveh elips $A$ in $B$, ter izbranega parametra $\lambda$. Tega omejimo na
interval $[0,1]$ tako, da je $F(\vec{r}, \lambda) \geq 0$. Pri fiksni vrednosti 
$\lambda$ ima $F(\vec{r}, \lambda)$ enolični minimum. 
Za skrajni vrednosti lahko trivialno zaključimo, da je minimum $F=0$ pri 
$\vec{r} = \vec{r}_B$ za $\lambda=0$ oziroma pri $\vec{r} = \vec{r}_A$ za 
$\lambda=1$. 
Za vse vmesne vrednosti $\lambda$ lego minimuma $\vec{r}$ dobimo z~minimizacijo.
Sledi
\begin{equation}
    \nabla F(\vec{r}, \lambda) = 0,
\end{equation}
oziroma
\begin{equation}
    \lambda \mathbf{A}^{-1} (\vec{r} - \vec{r}_A) + (1-\lambda) \mathbf{B}^{-1}
    (\vec{r} - \vec{r}_B) = 0.
    \label{eq:min_F}
\end{equation}
Rešitev minimizacije je pot $\vec{r}(\lambda)$ med centroma elips, ki jo lahko izrazimo 
iz enačbe~\ref{eq:min_F} kot sistem
\begin{align}
    \vec{r}(\lambda) &- \vec{r}_A = (1-\lambda) \mathbf{A} \mathbf{C}^{-1} 
        \vec{r}_{A B}, \nonumber \\
    \vec{r}(\lambda) &- \vec{r}_B = - \lambda \mathbf{B} \mathbf{C}^{-1} \vec{r}_{A B}, 
    \label{eq:rab}
\end{align}
kjer sta $\vec{r}_{A B} = \vec{r}_B - \vec{r}_A$ in $\mathbf{C}$ vsota
\begin{equation}
    \mathbf{C} = (1-\lambda) \mathbf{A} + \lambda \mathbf{B}.
    \label{eq:C}
\end{equation}
saj sta matriki $\mathbf{A}$ in $\mathbf{B}$ pozitivno 
definitni.
Rešitev~\ref{eq:rab} uporabimo v~enačbi~\ref{eq:F}, pri čemer upoštevamo tudi
enačbo~\ref{eq:C} in definiramo funkcijo $f$, ki ni več eksplicitno odvisna od 
$\vec{r}(\lambda)$
\begin{equation}
    f(\lambda) = F (\vec{r}(\lambda), \lambda) = \lambda (1-\lambda)
        \vec{r}_{A B}^{\top} \mathbf{C}^{-1} \vec{r}_{A B}.
\end{equation}
\begin{figure}[!ht]
    \centering
    \resizebox{.5\textwidth}{!}{\input{./figures/elipse.tex}}
    \caption{Minimalna pot $\vec{r}(\lambda)$ gre skozi presek elips $A$ in $B$.}
    \label{fig:path}
\end{figure}\\
\noindent Poglejmo kako se obnaša pot $\vec{r}(\lambda), \, \lambda \in [0,1]$, ki povezuje 
centra elips med seboj -- kar lahko vidimo na sliki~\ref{fig:path}.
Iz enačbe~\ref{eq:elipsa} sledi, da je vrednost $F(\vec{r}, \lambda)$ na območju 
izven obeh elips $F(\vec{r}, \lambda)>1$. Če se $A$ in $B$ ne sekata, potem mora imeti 
pot minimuma $F(\vec{r}, \lambda)>1$ vrednost večjo od $1$. Če se $A$ in $B$ prekrivata 
potem je vrednost $F(\vec{r}, \lambda)<1$ na preseku $A \cap B$ za katerokoli vrednost 
$\lambda \in [0,1]$.  Sledi, da je vrednost minimuma $F(\vec{r}, \lambda)<1$ zagotovo 
manjša od $1$. To pomeni, da pot $\vec{r}(\lambda)$ zagotovo ne bo šla izven območij
$A$ in $B$. Zaključimo, da za vrednosti $F(\vec{r}(\lambda), \lambda) = 
f(\lambda)$ velja
\begin{equation}
    \max_{0<\lambda<1} f(\lambda)
    \begin{cases}
        <1 \quad\text{$A$ in $B$ se prekrivata,}\\
        =1 \quad\text{$A$ in $B$ sta tangentni,}\\
        >1 \quad\text{$A$ in $B$ se ne dotikata.}
    \end{cases}
    \label{eq:kriterij}
\end{equation}
Te lastnosti izkoristimo pri definiciji kontaktne funkcije med dvema elipsama, tako da
velja
\begin{equation}
    F_{A B}(\vec{r}_{A B}, \theta_A, \theta_B) =
    \max_{0<\lambda<1} f(\lambda) = \mu^2.
    \label{eq:kontakt}
\end{equation}
Vrednost $\mu$ je linearni faktor s~katerim moramo množiti elipsi $A$ in $B$, da 
postaneta tangentni.
\subsection{Zaznavanje prekrivanj s~kontaktno funkcijo}
Vpeljano kontaktno funkcijo uporabimo na porazdelitvi elips, ki smo jo zgenerirali
z~Mitchellovim algoritmom. 
Za primer poglejmo sliko~\ref{fig:zaznavanje_trkov}, ki prikazuje porazdelitev
$128$ elips. Izberemo naključno elipso in pogledamo njeno okolico polmera $2a$.
S~tem zmanjšamo število parov elips na katerih moramo računati kontaktno funkcijo.
\begin{figure}[!ht]
    \centering
    \resizebox{.32\textwidth}{!}{\input{./figures/zaznavanje_prekrivanj1.tex}}
    \resizebox{.32\textwidth}{!}{\input{./figures/zaznavanje_prekrivanj2.tex}}
    \resizebox{.32\textwidth}{!}{\input{./figures/zaznavanje_prekrivanj3.tex}}
    \caption{Prikaz porazdelitve~$128$ elips.
    Na sredinski sliki izberemo naključno elipso in pogledamo njeno okolico polmera 
    $2a$. Na zadnji sliki so označene samo še tiste elipse iz okolice s~katerimi 
    se izbrana elipsa prekriva.}
    \label{fig:zaznavanje_trkov}
\end{figure}

\section{Numerika}
\begin{figure}[!ht]
    \centering
    \resizebox{.6\textwidth}{!}{\input{./figures/barvni_prikaz.tex}}
    \caption{Barva prekritih elips je odvisna od njihove energije.}
    \label{fig:energija}
\end{figure}
\subsection{Različni koraki rasti}
Pri isti začetni porazdelitvi točk, večkrat zgeneriramo porazdelitve elips z~različnimi
začetnimi naključnimi orientacijami. Na sliki~\ref{fig:delta_a_01} je prikazan tak primer
pri koraku rasti $\Delta a = 0,1$ pri začetni velikosti $a_0 = 5$ in končni $a = 8$. 
Razmerje med polosmi je $a/b = 5/2$.
\begin{figure}[!ht]
    \centering
    \includegraphics[width=0.38\textwidth]{./figures/runs/delta_a_01/run01}
    \includegraphics[width=0.38\textwidth]{./figures/runs/delta_a_01/run02}
    \includegraphics[width=0.38\textwidth]{./figures/runs/delta_a_01/run03}
    \includegraphics[width=0.38\textwidth]{./figures/runs/delta_a_01/run04}
    \includegraphics[width=0.38\textwidth]{./figures/runs/delta_a_01/run05}
    \includegraphics[width=0.38\textwidth]{./figures/runs/delta_a_01/run06}
    \includegraphics[width=0.38\textwidth]{./figures/runs/delta_a_01/run07}
    \includegraphics[width=0.38\textwidth]{./figures/runs/delta_a_01/run08}
    \includegraphics[width=0.38\textwidth]{./figures/runs/delta_a_01/run09}
    \includegraphics[width=0.38\textwidth]{./figures/runs/delta_a_01/run10}
    \caption{Razvoj sistema iz iste začetne porazdelitve $128$ elips in desetih različnih
    začetnih naključnih orientacijah. Velikost koraka je $\Delta a = 0,1$.}
    \label{fig:delta_a_01}
\end{figure}
Spodaj so prikazani grafi energije, povprečnega števila kontaktov na elipso, orientacijske
korelacijske funkcije in števila sprejetih in zavrnjenih rotacij med računanjem 
(če je med poskusom relaksacije sistema vrednost energije padla na $0$, se je računanje 
prekinilo -- zato se je kdaj zgodilo, da vsota sprejtih in zavrnjenih rotacij ni konstantna).
\begin{figure}
    \centering
    \resizebox{.45\textwidth}{!}{\input{./gnuplot/growth_a_01_energy_1.tex}}
    \resizebox{.45\textwidth}{!}{\input{./gnuplot/growth_a_01_energy_2.tex}}
    \resizebox{.45\textwidth}{!}{\input{./gnuplot/growth_a_01_coord_1.tex}}
    \resizebox{.45\textwidth}{!}{\input{./gnuplot/growth_a_01_coord_2.tex}}
    \resizebox{.45\textwidth}{!}{\input{./gnuplot/growth_a_01_correlation_1.tex}}
    \resizebox{.45\textwidth}{!}{\input{./gnuplot/growth_a_01_correlation_2.tex}}
    \resizebox{.45\textwidth}{!}{\input{./gnuplot/growth_a_01_rotations_1.tex}}
    \resizebox{.45\textwidth}{!}{\input{./gnuplot/growth_a_01_rotations_2.tex}}
    \caption{Spreminjanje energije, povprečnega števila kontaktov s~sosednjimi elipsami,
    korelacijske orientacijske funkcije in števila sprejetih ter zavrnjenih rotacij tekom
    relaksacije sistema. Povprečeno po desetih poskusih relaksacije.}
    \label{fig:average_a_01}
\end{figure}